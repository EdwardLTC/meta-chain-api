generator client {
  provider               = "prisma-client"
  output                 = "../generated/prisma"
  engineType             = "client"
  runtime                = "nodejs"
  generatedFileExtension = "mts"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String  @id @default(uuid())
  username      String
  walletAddress String  @unique
  email         String? @unique
  avatarUrl     String?
  bio           String?

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  collections Collection[]

  @@map("users")
}

enum CollectionStatus {
  NEW
  PENDING
  CREATED
  FAILED
}

model Collection {
  id              String           @id @default(uuid())
  status          CollectionStatus @default(PENDING)
  userId          String
  creatorAddress  String
  name            String
  symbol          String
  description     String
  image           String
  royaltyFeeBps   Int
  txHash          String?          @unique
  contractAddress String?          @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tokens    Token[]
  user      User     @relation(fields: [userId], references: [id])

  @@map("collections")
}

enum TokenStatus {
  NEW
  PENDING
  MINTED
  FAILED
}

model Token {
  id String @id @default(uuid())

  collection   Collection @relation(fields: [collectionId], references: [id])
  collectionId String

  contractAddress String?
  tokenId         String?
  ownerAddress    String
  tokenUri        String

  name        String
  description String
  image       String

  mintTxHash String?
  status     TokenStatus @default(NEW)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  listings Listing[]

  @@unique([contractAddress, tokenId])
  @@index([contractAddress])
  @@index([ownerAddress])
  @@map("tokens")
}

model Listing {
  id            String    @id @default(uuid())
  token         Token     @relation(fields: [tokenId], references: [id])
  tokenId       String
  sellerAddress String
  price         Decimal   @db.Decimal(36, 18)
  currency      String
  status        String    @default("active")
  expiresAt     DateTime?
  source        String // "offchain" | "onchain"
  orderData     Json?
  txHash        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  Order         Order[]

  @@index([sellerAddress])
  @@index([status])
  @@index([tokenId])
  @@map("listings")
}

model Order {
  id        String   @id @default(uuid())
  listing   Listing  @relation(fields: [listingId], references: [id])
  listingId String
  buyer     String
  seller    String
  price     Decimal  @db.Decimal(36, 18)
  txHash    String
  status    String   @default("pending")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([buyer])
  @@index([seller])
  @@index([status])
  @@map("orders")
}

model EventCursor {
  id        String @id
  lastBlock Int

  @@map("event_cursors")
}
