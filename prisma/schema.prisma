generator client {
  provider               = "prisma-client"
  output                 = "../generated/prisma"
  engineType             = "client"
  runtime                = "nodejs"
  generatedFileExtension = "mts"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  username      String
  walletAddress String   @unique
  email         String?  @unique
  avatarUrl     String?
  bio           String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("users")
}

model Collection {
  id              String   @id @default(uuid())
  contractAddress String   @unique
  name            String?
  symbol          String?
  creatorAddress  String?
  description     String?
  image           String?
  metadataJson    Json?
  totalSupply     Int?
  verified        Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  tokens          Token[]

  @@map("collections")
}

model Token {
  id              String           @id @default(uuid())
  contractAddress String
  tokenId         String
  ownerAddress    String
  tokenUri        String?
  name            String?
  description     String?
  image           String?
  metadataJson    Json?
  mintTxHash      String?
  firstSeenAt     DateTime?
  lastSyncedAt    DateTime?
  collection      Collection?      @relation(fields: [collectionId], references: [id])
  collectionId    String?
  listings        Listing[]
  attributes      TokenAttribute[]

  @@unique([contractAddress, tokenId])
  @@index([contractAddress])
  @@index([ownerAddress])
  @@map("tokens")
}

model TokenAttribute {
  id        String @id @default(uuid())
  token     Token  @relation(fields: [tokenId], references: [id])
  tokenId   String
  traitType String
  value     String
  rarity    Float?

  @@index([traitType])
  @@index([value])
  @@map("token_attributes")
}

model Listing {
  id            String    @id @default(uuid())
  token         Token     @relation(fields: [tokenId], references: [id])
  tokenId       String
  sellerAddress String
  price         Decimal   @db.Decimal(36, 18)
  currency      String
  status        String    @default("active")
  expiresAt     DateTime?
  source        String // "offchain" | "onchain"
  orderData     Json?
  txHash        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  Order         Order[]

  @@index([sellerAddress])
  @@index([status])
  @@index([tokenId])
  @@map("listings")
}

model Order {
  id        String   @id @default(uuid())
  listing   Listing  @relation(fields: [listingId], references: [id])
  listingId String
  buyer     String
  seller    String
  price     Decimal  @db.Decimal(36, 18)
  txHash    String
  status    String   @default("pending")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([buyer])
  @@index([seller])
  @@index([status])
  @@map("orders")
}

model BlockchainEvent {
  id              String   @id @default(uuid())
  txHash          String
  logIndex        Int
  eventType       String
  contractAddress String
  blockNumber     Int
  timestamp       DateTime
  rawData         Json
  createdAt       DateTime @default(now())

  @@index([txHash])
  @@index([contractAddress])
  @@map("blockchain_events")
}
