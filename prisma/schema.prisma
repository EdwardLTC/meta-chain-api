generator client {
  provider               = "prisma-client"
  output                 = "../generated/prisma"
  engineType             = "client"
  runtime                = "nodejs"
  generatedFileExtension = "mts"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String  @id @default(uuid())
  username      String
  walletAddress String  @unique
  email         String? @unique
  avatarUrl     String?
  bio           String?

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  collections Collection[]
  tokenLikes  TokenLike[]

  @@map("users")
}

enum CollectionStatus {
  PENDING
  CREATED
  FAILED
}

model Collection {
  id              String           @id
  status          CollectionStatus @default(PENDING)
  userId          String
  creatorAddress  String
  name            String
  symbol          String
  description     String
  image           String
  royaltyFeeBps   Int
  txData          Json
  txHash          String?          @unique
  contractAddress String?          @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tokens    Token[]
  user      User     @relation(fields: [userId], references: [id])

  @@map("collections")
}

enum TokenStatus {
  PENDING
  MINTED
  FAILED
}

model Token {
  id           String     @id
  collection   Collection @relation(fields: [collectionId], references: [id])
  collectionId String

  ownerAddress String
  tokenUri     String

  name        String
  description String
  image       String
  status      TokenStatus @default(PENDING)
  txData      Json

  txHash          String?
  onchainId       BigInt? /// on-chain token ID
  contractAddress String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  likeCount Int @default(0)

  listings   Listing[]
  tokenLikes TokenLike[]

  @@unique([contractAddress, onchainId])
  @@index([contractAddress])
  @@index([ownerAddress])
  @@map("tokens")
}

enum ListingStatus {
  PENDING
  ACTIVE
  SOLD
  CANCELLED
}

model Listing {
  id      String @id
  tokenId String
  token   Token  @relation(fields: [tokenId], references: [id])

  sellerAddress String
  price         String
  status        ListingStatus @default(PENDING)
  expiresAt     DateTime?
  txData        Json

  onchainId BigInt? @unique
  txHash    String?

  buyerAddress String?
  paymentToken String?
  soldAt       DateTime?

  marketFeeBps    String?
  marketFeeAmount String?

  feeRecipient String?

  royaltyReceiver String?
  royaltyAmount   String?

  sellerProceeds String?

  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  listingEvents ListingEventTracking[]

  @@map("listings")
}

enum ListingEventName {
  LISTED
  CANCELLED
  SOLD
}

model ListingEventTracking {
  id          String           @id @default(uuid())
  listingId   String
  listing     Listing          @relation(fields: [listingId], references: [id])
  eventName   ListingEventName
  txHash      String
  logIndex    Int
  blockNumber String
  payload     Json
  createdAt   DateTime         @default(now())

  @@map("listing_event_tracking")
}

model TokenLike {
  id        String   @id @default(uuid())
  userId    String
  tokenId   String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id])
  token Token @relation(fields: [tokenId], references: [id])

  @@unique([userId, tokenId]) // user can like once
  @@map("token_likes")
}

model ChainCursor {
  listenerId String   @unique
  lastBlock  String
  updatedAt  DateTime @updatedAt

  @@map("chain_cursors")
}

model ProcessedLog {
  listenerId String
  txHash     String
  logIndex   Int

  @@id([listenerId, txHash, logIndex])
  @@map("processed_logs")
}

model DeadLetterEvent {
  id           String   @id @default(uuid())
  listenerId   String
  eventName    String
  txHash       String
  logIndex     Int
  blockNumber  String
  payload      Json
  errorMessage String
  retryCount   Int      @default(0)
  resolved     Boolean  @default(false)
  createdAt    DateTime @default(now())

  @@unique([listenerId, txHash, logIndex])
  @@map("dead_letter_events")
}
